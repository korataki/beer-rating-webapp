<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>–û—Ü–µ–Ω–∫–∞ –ü–∏–≤–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      text-align: center;
    }
    .rating-buttons button {
      margin: 4px;
      padding: 10px 16px;
      font-size: 16px;
    }
    .hidden { display: none; }
  </style>
</head>
<body>

<h2 id="beer-name">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
<p id="beer-info"></p>

<div class="rating-buttons" id="rating-buttons">
  <button onclick="sendVote(0)">0</button>
  <button onclick="sendVote(1)">1</button>
  <button onclick="sendVote(2)">2</button>
  <button onclick="sendVote(3)">3</button>
  <button onclick="sendVote(4)">4</button>
  <button onclick="sendVote(5)">5</button>
  <button onclick="sendVote(6)">6</button>
  <button onclick="sendVote(7)">7</button>
  <button onclick="sendVote(8)">8</button>
  <button onclick="sendVote(9)">9</button>
  <button onclick="sendVote(10)">10</button>
  <button onclick="sendVote(null)">–ù–µ –∑–Ω–∞—é ü§∑</button>
</div>

<script>
let tg = window.Telegram?.WebApp;
let userId = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
if (tg) {
  tg.ready();
  if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
    userId = tg.initDataUnsafe.user.id;
  } else {
    userId = 'anonymous_' + Math.floor(Math.random() * 1000000); // fallback –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞
  }
} else {
  userId = 'anonymous_' + Math.floor(Math.random() * 1000000); // fallback –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞
}

async function loadRandomBeer() {
  try {
    const res = await fetch('https://script.google.com/macros/s/AKfycbwxmJQZjMpBOzj_PJ0FaIN7JYwdIHxSGA0bgjKe3M3uBRgRvuPGm7KbjLMJh4VtsDjXsQ/exec?action=random');
    
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }
    
    const data = await res.json();
    
    if (!data || !data.name) {
      throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
    }
    
    window.currentBeer = data;
    document.getElementById('beer-name').textContent = data.name;
    document.getElementById('beer-info').textContent = data.country || '–°—Ç—Ä–∞–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞';
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∏–≤–∞:", err);
    document.getElementById('beer-name').textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ :(";
    document.getElementById('beer-info').textContent = "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É";
  }
}

async function sendVote(score) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–∏–≤–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
  if (!window.currentBeer || !window.currentBeer.id) {
    alert("–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –æ –ø–∏–≤–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
    return;
  }

  try {
    const payload = {
      action: 'vote',
      userId: userId,
      beerId: window.currentBeer.id,
      score: score
    };

    const res = await fetch('https://script.google.com/macros/s/AKfycbwxmJQZjMpBOzj_PJ0FaIN7JYwdIHxSGA0bgjKe3M3uBRgRvuPGm7KbjLMJh4VtsDjXsQ/exec', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }

    const result = await res.json();
    
    if (result.success !== false) {
      alert(result.message || "–ì–æ–ª–æ—Å —É—á—Ç—ë–Ω!");
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–µ–¥—É—é—â–µ–µ –ø–∏–≤–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
      loadRandomBeer();
    } else {
      alert(result.message || "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≥–æ–ª–æ—Å–∞");
    }
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–∞:", err);
    alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.");
  }
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤–æ–µ –ø–∏–≤–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
loadRandomBeer();
</script> 

</body>
</html>
